<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blessed Flight – Final Antibugs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    :root { --w: 400px; --h: 700px; }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; display:flex; justify-content:center; align-items:center;
      height:100vh; background:#000; font-family:'Fredoka One',system-ui,sans-serif; overflow:hidden;
    }
    #gameWrapper { position: relative; }
    #gameContainer {
      position:relative; width:var(--w); height:var(--h);
      overflow:hidden; border:4px solid yellow; border-radius:20px; box-shadow:0 0 20px yellow;
      background:#87ceeb; touch-action:none; transform-origin:center center;
    }
    canvas { display:block; width:100%; height:100%; z-index:1; }

    /* Menú y Game Over */
    #menu, #gameOverScreen { position:absolute; inset:0; display:none; }
    #menu {
      flex-direction:column; align-items:flex-end; justify-content:flex-end;
      padding:0 20px 60px 20px; z-index:10;
      background:url("PRINCIPAL.png?v=10") no-repeat center/cover; pointer-events:auto;
    }
    .btn {
      font-size:2em; color:yellow; background:black; border:4px solid yellow;
      padding:12px 28px; border-radius:20px; cursor:pointer; text-shadow:3px 3px 0 #000;
      margin-top:20px; box-shadow:0 0 15px yellow; transition:transform 0.2s ease;
    }
    .btn:hover { transform:scale(1.06); }
    .best { color:white; font-size:1.1em; text-shadow:2px 2px 0 #000; margin-top:10px; align-self:center; }
    #gameOverScreen {
      background:rgba(0,0,0,0.92); z-index:4; flex-direction:column; align-items:center; justify-content:center; padding:20px;
    }
    #gameOverScreen img { width:200px; margin-bottom:18px; filter:drop-shadow(0 0 15px red); }
    #gameOverScreen h1 { font-size:2.5em; color:#ff3b3b; margin:0 0 8px; text-shadow:3px 3px 8px #000; letter-spacing:2px; }
    #finalScore { color:white; font-size:1.4em; margin-bottom:18px; text-shadow:2px 2px 5px #000; }

    /* Joystick */
    #joystick {
      position:absolute; bottom:60px; left:60px; width:120px; height:120px; border-radius:50%;
      background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3); display:none; z-index:20; touch-action:none;
    }
    #joystickKnob { position:absolute; top:50%; left:50%; width:60px; height:60px; margin-left:-30px; margin-top:-30px; border-radius:50%; background:rgba(255,255,255,0.4); border:2px solid rgba(255,255,255,0.5); }

    /* LOADING (barra + texto animado) */
    #loadingScreen { position:absolute; inset:0; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:200; }
    #loadingRow { display:flex; align-items:center; gap:10px; }
    #loadingText { font-size:1.2em; }
    #loadingDots { width:30px; text-align:left; display:inline-block; }
    #loadingBar { width:80%; height:12px; background:#333; border-radius:10px; overflow:hidden; margin-top:12px; }
    #loadingBar > div { width:0%; height:100%; background:yellow; transition:width 0.2s ease; }

    /* Overlay orientación */
    #rotateOverlay {
      position:fixed; inset:0; background:#000c; color:white;
      font-size:2em; display:none; justify-content:center; align-items:center; z-index:300;
    }
  </style>
</head>
<body>
  <div id="rotateOverlay">↻ Gira tu dispositivo</div>
  <div id="gameWrapper">
    <div id="gameContainer">
      <!-- Loading -->
      <div id="loadingScreen">
        <div id="loadingRow">
          <div id="loadingText">LOADING</div><div id="loadingDots">...</div><div id="loadingPct">0%</div>
        </div>
        <div id="loadingBar"><div></div></div>
      </div>

      <!-- Menú -->
      <div id="menu">
        <button id="playBtn" class="btn" disabled>PLAY</button>
        <div class="best">Best Score: <span id="bestScore">0</span></div>
      </div>

      <!-- Game Over -->
      <div id="gameOverScreen">
        <img src="demonio.png?v=10" alt="Demonio sombrío" />
        <h1>CURSED</h1>
        <div id="finalScore">Score: 0</div>
        <button id="againBtn" class="btn" disabled>FLIGHT AGAIN</button>
      </div>

      <canvas id="gameCanvas"></canvas>
      <div id="joystick"><div id="joystickKnob"></div></div>
    </div>
  </div>

  <audio id="bgMusic" src="musica_fondo.mp3?v=10" loop playsinline preload="none" muted></audio>

  <script>
(() => {
  const GAME_WIDTH=400, GAME_HEIGHT=700, basePlayerSpeed=4.2;
  const MAX_CLOUDS=40;
  let STAR_COUNT = (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4) ? 50 : 100;

  const container=document.getElementById("gameContainer");
  const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
  const loadingScreen=document.getElementById("loadingScreen");
  const loadingDots=document.getElementById("loadingDots");
  const loadingPct=document.getElementById("loadingPct");
  const loadingBar=document.querySelector("#loadingBar > div");
  const menu=document.getElementById("menu"),playBtn=document.getElementById("playBtn");
  const gameOverScreen=document.getElementById("gameOverScreen"),againBtn=document.getElementById("againBtn");
  const bestScoreDisplay=document.getElementById("bestScore"),finalScoreDisplay=document.getElementById("finalScore");
  const bgMusic=document.getElementById("bgMusic");
  const joystick=document.getElementById("joystick"),joystickKnob=document.getElementById("joystickKnob");
  const rotateOverlay=document.getElementById("rotateOverlay");

  // Resize + HiDPI
  function fitToViewport(){
    const borderExtra = 8+20;
    const scale=Math.min(window.innerWidth/(400+borderExtra),window.innerHeight/(700+borderExtra),1);
    container.style.transform=`scale(${scale})`;
  }
  function resizeCanvas(){
    const dpr=window.devicePixelRatio||1;
    canvas.style.width=GAME_WIDTH+"px"; canvas.style.height=GAME_HEIGHT+"px";
    canvas.width=GAME_WIDTH*dpr; canvas.height=GAME_HEIGHT*dpr;
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  }
  window.addEventListener("resize",()=>{fitToViewport();resizeCanvas();checkOrientation();});
  fitToViewport();resizeCanvas();

  // Orientación
  function checkOrientation(){
    if(window.innerWidth>window.innerHeight) rotateOverlay.style.display="flex";
    else rotateOverlay.style.display="none";
  }
  window.addEventListener("orientationchange",checkOrientation); checkOrientation();

  // Storage seguro
  function lsGet(k,d=0){try{return Number(localStorage.getItem(k)??d);}catch{console.warn("localStorage inaccesible");return d;}}
  function lsSet(k,v){try{localStorage.setItem(k,v);}catch{console.warn("No se pudo guardar score");}}
  bestScoreDisplay.textContent=lsGet("bestScore",0);

  // Loader assets
  const assetList=["gato.png?v=10","nube_grande.png?v=10","nube_pequeña.png?v=10","nube_negra.png?v=10","nube_negra_pequeña.png?v=10","PRINCIPAL.png?v=10","demonio.png?v=10"];
  function loadImage(src){
    return new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>{console.warn("No se pudo cargar",src);const c=document.createElement("canvas");c.width=c.height=50;const cx=c.getContext("2d");cx.fillStyle="magenta";cx.fillRect(0,0,50,50);res(c);};
      img.src=src;
    });
  }

  let playerImg,cloudImgs=[];
  async function preloadAll(){
    let done=0,total=assetList.length;
    function tick(){done++;const p=Math.round(done*100/total);loadingPct.textContent=p+"%";loadingBar.style.width=p+"%";}
    const imgs=await Promise.all(assetList.map(async s=>{const r=await loadImage(s);tick();return r;}));
    playerImg=imgs[0]; cloudImgs=imgs.slice(1,5);
    loadingScreen.style.display="none"; menu.style.display="flex"; playBtn.disabled=false; againBtn.disabled=false;
  }

  // Animación LOADING ...
  let dotStep=0; setInterval(()=>{dotStep=(dotStep+1)%4; loadingDots.textContent=".".repeat(dotStep);},350);

  // Audio seguro + reintento
  function safeStart(){try{if(bgMusic.paused){bgMusic.muted=false;bgMusic.currentTime=0;bgMusic.play().catch(()=>{});}}catch{} startGame();}
  document.addEventListener("visibilitychange",()=>{if(!document.hidden) safeStart();});

  playBtn.addEventListener("click",safeStart); againBtn.addEventListener("click",safeStart);

  // ================= Juego =================
  let player,clouds,stars,score,running,falling,fallVelocity,rotation;
  let spawnTimer,spawnEvery,lastFrame,speedFactor,milestoneMsg,milestoneColor,milestoneStart,reached;

  function resetVariables(){
    player={x:GAME_WIDTH/2-28,y:GAME_HEIGHT-120,w:56,h:56,speed:basePlayerSpeed};
    clouds=[]; stars=[]; score=0; running=false; falling=false; fallVelocity=0; rotation=0;
    spawnTimer=0; spawnEvery=1500; lastFrame=performance.now();
    speedFactor=1.0; milestoneMsg=null; milestoneColor="yellow"; milestoneStart=0; reached=new Set();
    stars=[];for(let i=0;i<STAR_COUNT;i++) stars.push({x:Math.random()*GAME_WIDTH,y:Math.random()*GAME_HEIGHT,r:Math.random()*2,color:Math.random()>0.5?"yellow":"black",speed:0.2+Math.random()*0.8});
  }

  const milestones=[{at:20,label:"DEVOTED",color:"gray"},{at:40,label:"ENLIGHTENED",color:"orange"},{at:60,label:"BLESSED",color:"yellow"},{at:80,label:"MONK",color:"#FFD700"}];

  function maybeMilestone(){for(const m of milestones){if(score>=m.at&&!reached.has(m.at)){reached.add(m.at);milestoneMsg=m.label;milestoneColor=m.color;milestoneStart=performance.now();if(m.label==="DEVOTED"){speedFactor+=1.0;spawnEvery=1000;}else if(m.label==="ENLIGHTENED"){speedFactor+=1.2;spawnEvery=700;}else if(m.label==="BLESSED"){speedFactor+=1.5;spawnEvery=500;}else if(m.label==="MONK"){speedFactor+=2.0;spawnEvery=300;}player.speed=basePlayerSpeed*(1+(speedFactor-1)/2);}}}
  function drawMilestone(now){if(!milestoneMsg)return;const elapsed=now-milestoneStart;if(elapsed>1500){milestoneMsg=null;return;}ctx.save();ctx.fillStyle=milestoneColor;ctx.font="40px Fredoka One";ctx.textAlign="center";ctx.fillText(milestoneMsg,GAME_WIDTH/2,GAME_HEIGHT/2);ctx.restore();}

  function endGame(){running=false;try{bgMusic.pause();}catch{}gameOverScreen.style.display="flex";finalScoreDisplay.textContent="Score: "+Math.floor(score);const best=lsGet("bestScore",0);if(score>best){lsSet("bestScore",Math.floor(score));bestScoreDisplay.textContent=Math.floor(score);}}
  function startGame(){resetVariables();menu.style.display="none";gameOverScreen.style.display="none";running=true;requestAnimationFrame(loop);}

  // Input
  const keys={}; window.addEventListener("keydown",e=>{if(e.code==="Space"){if(menu.style.display!=="none"||gameOverScreen.style.display!=="none")safeStart();e.preventDefault();return;}keys[e.key.toLowerCase()]=true;});
  window.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false;});

  // Joystick
  let joyActive=false,joyCenter={x:0,y:0},joyPos={x:0,y:0},activeTouchId=null;
  const joyMax=50;
  container.addEventListener("touchstart",e=>{if(!running||joyActive)return;const t=e.changedTouches[0];if(t.clientY<window.innerHeight/2)return;joyActive=true;activeTouchId=t.identifier;joyCenter.x=t.clientX;joyCenter.y=t.clientY;joystick.style.display="block";joystick.style.left=(joyCenter.x-60)+"px";joystick.style.top=(joyCenter.y-60)+"px";},{passive:true});
  container.addEventListener("touchmove",e=>{if(!joyActive)return;const t=[...e.changedTouches].find(tt=>tt.identifier===activeTouchId);if(!t)return;let dx=t.clientX-joyCenter.x,dy=t.clientY-joyCenter.y;const dist=Math.min(Math.hypot(dx,dy),joyMax);const angle=Math.atan2(dy,dx);joyPos.x=Math.cos(angle)*dist/joyMax;joyPos.y=Math.sin(angle)*dist/joyMax;joystickKnob.style.transform=`translate(${joyPos.x*40}px,${joyPos.y*40}px)`;},{passive:true});
  function releaseJoystick(){joyActive=false;activeTouchId=null;joyPos.x=0;joyPos.y=0;joystick.style.display="none";joystickKnob.style.transform="translate(0,0)";}
  container.addEventListener("touchend",e=>{if([...e.changedTouches].some(tt=>tt.identifier===activeTouchId))releaseJoystick();},{passive:true});
  container.addEventListener("touchcancel",e=>{if([...e.changedTouches].some(tt=>tt.identifier===activeTouchId))releaseJoystick();},{passive:true});

  function newCloud(){const img=cloudImgs[Math.floor(Math.random()*cloudImgs.length)];const size=70+Math.random()*50;return{x:Math.random()*(GAME_WIDTH-size),y:-size,w:size,h:size,speed:1+speedFactor,img};}

  function loop(now){if(!running)return;const dt=Math.min(50,now-lastFrame);lastFrame=now;ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT);
    for(const s of stars){s.y+=s.speed;if(s.y>GAME_HEIGHT){s.y=0;s.x=Math.random()*GAME_WIDTH;}ctx.fillStyle=s.color;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}
    if(!falling){if(keys["a"]||keys["arrowleft"])player.x-=player.speed;if(keys["d"]||keys["arrowright"])player.x+=player.speed;if(keys["w"]||keys["arrowup"])player.y-=player.speed;if(keys["s"]||keys["arrowdown"])player.y+=player.speed;player.x+=joyPos.x*player.speed*3;player.y+=joyPos.y*player.speed*3;player.x=Math.max(0,Math.min(GAME_WIDTH-player.w,player.x));player.y=Math.max(0,Math.min(GAME_HEIGHT-player.h,player.y));}else{fallVelocity+=0.5;player.y+=fallVelocity;rotation+=0.12;if(player.y>GAME_HEIGHT+40){endGame();return;}}
    spawnTimer+=dt;while(spawnTimer>=spawnEvery){spawnTimer-=spawnEvery;clouds.push(newCloud());if(clouds.length>MAX_CLOUDS)clouds.shift();}
    const pRect={x:player.x,y:player.y,w:player.w,h:player.h};for(let i=0;i<clouds.length;i++){const c=clouds[i];c.y+=c.speed;ctx.drawImage(c.img,c.x,c.y,c.w,c.h);if(!falling&&!(pRect.x+pRect.w<c.x||pRect.x>c.x+c.w||pRect.y+pRect.h<c.y||pRect.y>c.y+c.h)){falling=true;fallVelocity=-8;rotation=0;}if(c.y>GAME_HEIGHT+60){clouds.splice(i,1);i--;}}
    ctx.save();ctx.translate(player.x+player.w/2,player.y+player.h/2);ctx.rotate(rotation);ctx.drawImage(playerImg,-player.w/2,-player.h/2,player.w,player.h);ctx.restore();
    if(!falling){score+=dt/1000;maybeMilestone();}ctx.fillStyle="yellow";ctx.font="20px Fredoka One";ctx.fillText("Score: "+Math.floor(score),10,30);drawMilestone(now);
    requestAnimationFrame(loop);}
  
  // Service Worker dinámico
  if("serviceWorker" in navigator){const swCode=`self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('bf-cache-${Date.now()}').then(c=>c.addAll(['./','./index.html','gato.png?v=10','nube_grande.png?v=10','nube_pequeña.png?v=10','nube_negra.png?v=10','nube_negra_pequeña.png?v=10','PRINCIPAL.png?v=10','demonio.png?v=10','musica_fondo.mp3?v=10']).catch(()=>{})));});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;const blob=new Blob([swCode],{type:"text/javascript"});const url=URL.createObjectURL(blob);navigator.serviceWorker.register(url).catch(()=>{});}
  
  preloadAll();
})();
  </script>
</body>
</html>
