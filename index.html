<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blessed Flight – Final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    :root { --w: 400px; --h: 700px; }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; display:flex; justify-content:center; align-items:center;
      height:100vh; background:#000; font-family:'Fredoka One',system-ui,sans-serif; overflow:hidden;
    }
    #gameWrapper { position: relative; }
    #gameContainer {
      position:relative; width:var(--w); height:var(--h);
      overflow:hidden; border:4px solid yellow; border-radius:20px; box-shadow:0 0 20px yellow;
      background:#87ceeb; touch-action:none; transform-origin:center center;
    }
    canvas { display:block; width:100%; height:100%; z-index:1; }

    /* Menú y Game Over */
    #menu, #gameOverScreen { position:absolute; inset:0; display:none; }
    #menu {
      flex-direction:column; align-items:flex-end; justify-content:flex-end;
      padding:0 20px 60px 20px; z-index:10;
      background:url("PRINCIPAL.png") no-repeat center/cover; pointer-events:auto;
    }
    .btn {
      font-size:2em; color:yellow; background:black; border:4px solid yellow;
      padding:12px 28px; border-radius:20px; cursor:pointer; text-shadow:3px 3px 0 #000;
      margin-top:20px; box-shadow:0 0 15px yellow; transition:transform 0.2s ease;
    }
    .btn:hover { transform:scale(1.06); }
    .best { color:white; font-size:1.1em; text-shadow:2px 2px 0 #000; margin-top:10px; align-self:center; }
    #gameOverScreen {
      background:rgba(0,0,0,0.92); z-index:4; flex-direction:column; align-items:center; justify-content:center; padding:20px;
    }
    #gameOverScreen img { width:200px; margin-bottom:18px; filter:drop-shadow(0 0 15px red); }
    #gameOverScreen h1 { font-size:2.5em; color:#ff3b3b; margin:0 0 8px; text-shadow:3px 3px 8px #000; letter-spacing:2px; }
    #finalScore { color:white; font-size:1.4em; margin-bottom:18px; text-shadow:2px 2px 5px #000; }

    /* Joystick */
    #joystick {
      position:absolute; bottom:60px; left:60px; width:120px; height:120px; border-radius:50%;
      background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3); display:none; z-index:20; touch-action:none;
    }
    #joystickKnob { position:absolute; top:50%; left:50%; width:60px; height:60px; margin-left:-30px; margin-top:-30px; border-radius:50%; background:rgba(255,255,255,0.4); border:2px solid rgba(255,255,255,0.5); }

    /* LOADING (barra + texto animado) */
    #loadingScreen { position:absolute; inset:0; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:200; }
    #loadingRow { display:flex; align-items:center; gap:10px; }
    #loadingText { font-size:1.2em; }
    #loadingDots { width:30px; text-align:left; display:inline-block; }
    #loadingBar { width:80%; height:12px; background:#333; border-radius:10px; overflow:hidden; margin-top:12px; }
    #loadingBar > div { width:0%; height:100%; background:yellow; transition:width 0.2s ease; }

    /* Overlay orientación */
    #rotateOverlay {
      position:fixed; inset:0; background:#000c; color:white;
      font-size:2em; display:none; justify-content:center; align-items:center; z-index:300;
    }
  </style>
</head>
<body>
  <div id="rotateOverlay">↻ Gira tu dispositivo</div>
  <div id="gameWrapper">
    <div id="gameContainer">
      <!-- Loading -->
      <div id="loadingScreen">
        <div id="loadingRow">
          <div id="loadingText">LOADING</div><div id="loadingDots">...</div><div id="loadingPct">0%</div>
        </div>
        <div id="loadingBar"><div></div></div>
      </div>

      <!-- Menú -->
      <div id="menu">
        <button id="playBtn" class="btn" disabled>PLAY</button>
        <div class="best">Best Score: <span id="bestScore">0</span></div>
      </div>

      <!-- Game Over -->
      <div id="gameOverScreen">
        <img src="demonio.png" alt="Demonio sombrío" />
        <h1>CURSED</h1>
        <div id="finalScore">Score: 0</div>
        <button id="againBtn" class="btn" disabled>FLIGHT AGAIN</button>
      </div>

      <canvas id="gameCanvas"></canvas>
      <div id="joystick"><div id="joystickKnob"></div></div>
    </div>
  </div>

  <audio id="bgMusic" src="musica_fondo.mp3" loop playsinline preload="none" muted></audio>

  <script>
(() => {
  const GAME_WIDTH=400, GAME_HEIGHT=700, basePlayerSpeed=4.2;
  const MAX_CLOUDS=40;
  let STAR_COUNT=(navigator.hardwareConcurrency && navigator.hardwareConcurrency<=4)?50:100;

  const container=document.getElementById("gameContainer");
  const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
  const loadingScreen=document.getElementById("loadingScreen");
  const loadingDots=document.getElementById("loadingDots");
  const loadingPct=document.getElementById("loadingPct");
  const loadingBar=document.querySelector("#loadingBar > div");
  const menu=document.getElementById("menu"),playBtn=document.getElementById("playBtn");
  const gameOverScreen=document.getElementById("gameOverScreen"),againBtn=document.getElementById("againBtn");
  const bestScoreDisplay=document.getElementById("bestScore"),finalScoreDisplay=document.getElementById("finalScore");
  const bgMusic=document.getElementById("bgMusic");
  const joystick=document.getElementById("joystick"),joystickKnob=document.getElementById("joystickKnob");
  const rotateOverlay=document.getElementById("rotateOverlay");

  // Fit & resize
  function fitToViewport(){
    const borderExtra=8+20;
    const scale=Math.min(window.innerWidth/(400+borderExtra),window.innerHeight/(700+borderExtra),1);
    container.style.transform=`scale(${scale})`;
  }
  function resizeCanvas(){
    const dpr=window.devicePixelRatio||1;
    canvas.style.width=GAME_WIDTH+"px"; canvas.style.height=GAME_HEIGHT+"px";
    canvas.width=GAME_WIDTH*dpr; canvas.height=GAME_HEIGHT*dpr;
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  }
  window.addEventListener("resize",()=>{fitToViewport();resizeCanvas();checkOrientation();});
  fitToViewport();resizeCanvas();

  // Orientación
  function checkOrientation(){
    if(window.innerWidth>window.innerHeight) rotateOverlay.style.display="flex";
    else rotateOverlay.style.display="none";
  }
  window.addEventListener("orientationchange",checkOrientation); checkOrientation();

  // Storage seguro
  function lsGet(k,d=0){try{return Number(localStorage.getItem(k)??d);}catch{return d;}}
  function lsSet(k,v){try{localStorage.setItem(k,v);}catch{}}
  bestScoreDisplay.textContent=lsGet("bestScore",0);

  // Loader assets
  const assetList=["gato.png","nube_grande.png","nube_pequeña.png","nube_negra.png","nube_negra_pequeña.png","PRINCIPAL.png","demonio.png"];
  function loadImage(src){
    return new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>{console.warn("No se pudo cargar",src);const c=document.createElement("canvas");c.width=c.height=50;const cx=c.getContext("2d");cx.fillStyle="magenta";cx.fillRect(0,0,50,50);res(c);};
      img.src=src;
    });
  }

  let playerImg,cloudImgs=[];
  async function preloadAll(){
    let done=0,total=assetList.length;
    function tick(){done++;const p=Math.round(done*100/total);loadingPct.textContent=p+"%";loadingBar.style.width=p+"%";}
    const imgs=await Promise.all(assetList.map(async s=>{const r=await loadImage(s);tick();return r;}));
    playerImg=imgs[0]; cloudImgs=imgs.slice(1,5);
    loadingScreen.style.display="none"; menu.style.display="flex"; playBtn.disabled=false; againBtn.disabled=false;
  }

  // Animación LOADING ...
  let dotStep=0; setInterval(()=>{dotStep=(dotStep+1)%4; loadingDots.textContent=".".repeat(dotStep);},350);

  // Audio seguro
  function safeStart(){try{if(bgMusic.paused){bgMusic.muted=false;bgMusic.currentTime=0;bgMusic.play().catch(()=>{});}}catch{} startGame();}
  document.addEventListener("visibilitychange",()=>{if(!document.hidden) safeStart();});
  playBtn.addEventListener("click",safeStart); againBtn.addEventListener("click",safeStart);

  // Juego
  let player,clouds,stars,score,running;
  function resetVariables(){
    player={x:GAME_WIDTH/2-28,y:GAME_HEIGHT-120,w:56,h:56,speed:basePlayerSpeed};
    clouds=[]; stars=[]; score=0; running=false;
  }

  function endGame(){running=false;bgMusic.pause();gameOverScreen.style.display="flex";finalScoreDisplay.textContent="Score: "+Math.floor(score);const best=lsGet("bestScore",0);if(score>best){lsSet("bestScore",Math.floor(score));bestScoreDisplay.textContent=Math.floor(score);}}
  function startGame(){resetVariables();menu.style.display="none";gameOverScreen.style.display="none";running=true;requestAnimationFrame(loop);}

  // Input
  const keys={}; 
  window.addEventListener("keydown",e=>{
    if(e.code==="Space"){if(menu.style.display!=="none"||gameOverScreen.style.display!=="none"){if(!playBtn.disabled) safeStart();}e.preventDefault();return;}
    keys[e.key.toLowerCase()]=true;});
  window.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false;});

  function loop(){if(!running)return;ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT);
    ctx.fillStyle="yellow";ctx.font="20px Fredoka One";ctx.fillText("Score: "+Math.floor(score),10,30);
    requestAnimationFrame(loop);
  }

  preloadAll();
})();
  </script>
</body>
</html>
