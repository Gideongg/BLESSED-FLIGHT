<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blessed Flight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    :root{--accent:yellow;--bg:black;}
    *{box-sizing:border-box;}
    body {
      margin:0; padding:0; display:flex; justify-content:center; align-items:center;
      height:100vh; background:var(--bg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    #gameContainer {
      position:relative; width:400px; height:700px; max-width:100vw; max-height:100vh;
      overflow:hidden; border:4px solid var(--accent); border-radius:20px; box-shadow:0 0 20px var(--accent);
      background:#87ceeb; touch-action:none;
    }
    canvas { display:block; width:100%; height:100%; z-index:1; }
    /* ‚è≥ Loading overlay SIEMPRE visible de inicio */
    #loadingScreen {
      position:absolute; inset:0; background:var(--bg); color:var(--accent);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:16px; font-size:1.4rem; z-index:100;
    }
    #progressWrap {
      width:70%; height:14px; background:#222; border:2px solid var(--accent); border-radius:999px; overflow:hidden;
      box-shadow:0 0 10px var(--accent);
    }
    #progressBar { height:100%; width:0%; background:var(--accent); transition:width .2s ease; }
    #loadingHint{font-size:.9rem; color:#ddd; opacity:.9; text-align:center; padding:0 12px;}
    /* Men√∫ oculto por defecto y sin fondo hasta mostrarlo (evita descarga pesada) */
    #menu {
      position:absolute; inset:0; display:none; flex-direction:column; align-items:flex-end; justify-content:flex-end;
      padding:0 20px 60px 20px; z-index:10; pointer-events:auto; background:#000; background-size:cover; background-position:center;
    }
    .btn {
      font-size:2em; color:var(--accent); background:black; border:4px solid var(--accent);
      padding:12px 28px; border-radius:20px; cursor:pointer; text-shadow:3px 3px 0 #000;
      margin-top:20px; box-shadow:0 0 15px var(--accent); transition:transform 0.2s ease;
    }
    .btn:hover { transform:scale(1.06); }
    .best { color:white; font-size:1.1em; text-shadow:2px 2px 0 #000; margin-top:10px; align-self:center; }
    #gameOverScreen {
      position:absolute; inset:0; background:rgba(0,0,0,0.92); z-index:4; display:none;
      flex-direction:column; align-items:center; justify-content:center; padding:20px;
    }
    #gameOverScreen img { width:200px; margin-bottom:18px; filter:drop-shadow(0 0 15px red); }
    #gameOverScreen h1 { font-size:2.5em; color:#ff3b3b; margin:0 0 8px; text-shadow:3px 3px 8px #000; letter-spacing:2px; }
    #finalScore { color:white; font-size:1.4em; margin-bottom:18px; text-shadow:2px 2px 5px #000; }
    /* üéÆ Joystick Digital */
    #joystick {
      position:absolute; bottom:60px; left:60px;
      width:120px; height:120px; border-radius:50%; background:rgba(255,255,255,0.15);
      border:2px solid rgba(255,255,255,0.3); display:none; z-index:20; touch-action:none;
    }
    #joystickKnob {
      position:absolute; top:50%; left:50%; width:60px; height:60px;
      margin-left:-30px; margin-top:-30px; border-radius:50%;
      background:rgba(255,255,255,0.4); border:2px solid rgba(255,255,255,0.5);
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <!-- ‚è≥ Pantalla de carga -->
    <div id="loadingScreen" aria-live="polite">
      <div> Cargando‚Ä¶</div>
      <div id="progressWrap"><div id="progressBar"></div></div>
      <div id="loadingPercent">0%</div>
      <div id="loadingHint">Si tarda en GitHub Pages, es normal la primera vez. Estamos preparando los recursos‚Ä¶</div>
    </div>

    <!-- Men√∫ (fondo se inyecta despu√©s para evitar bloquear el primer render) -->
    <div id="menu" data-bg-src="PRINCIPAL (2).png">
      <button id="playBtn" class="btn">PLAY</button>
      <div class="best">Best Score: <span id="bestScore">0</span></div>
    </div>

    <div id="gameOverScreen">
      <img src="demonio.png" alt="Demonio sombr√≠o" />
      <h1>CURSED</h1>
      <div id="finalScore">Score: 0</div>
      <button id="againBtn" class="btn">FLIGHT AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- üéÆ Joystick Digital -->
    <div id="joystick"><div id="joystickKnob"></div></div>
  </div>

  <!-- ‚ö†Ô∏è No bloqueamos la primera pintura con audio pesado -->
  <audio id="bgMusic" src="musica_fondo.mp3" loop preload="metadata" playsinline></audio>

  <script>
  (() => {
    const GAME_WIDTH=400,GAME_HEIGHT=700,basePlayerSpeed=4.2;
    const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
    const menu=document.getElementById("menu"),playBtn=document.getElementById("playBtn");
    const gameOverScreen=document.getElementById("gameOverScreen"),againBtn=document.getElementById("againBtn");
    const bestScoreDisplay=document.getElementById("bestScore"),finalScoreDisplay=document.getElementById("finalScore");
    const bgMusic=document.getElementById("bgMusic");
    const joystick=document.getElementById("joystick"),joystickKnob=document.getElementById("joystickKnob");
    const loadingScreen=document.getElementById("loadingScreen");
    const progressBar=document.getElementById("progressBar");
    const loadingPercent=document.getElementById("loadingPercent");

    function resizeCanvas(){
      const dpr=window.devicePixelRatio||1;
      canvas.style.width=GAME_WIDTH+"px";canvas.style.height=GAME_HEIGHT+"px";
      canvas.width=GAME_WIDTH*dpr;canvas.height=GAME_HEIGHT*dpr;
      ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);
    }
    window.addEventListener("resize",resizeCanvas);resizeCanvas();

    let player,clouds,stars,score=0,running=false,falling=false,fallVelocity=0,rotation=0;
    let spawnTimer=0,spawnEvery=1500,lastFrame=0,speedFactor=1.5;
    let milestoneMsg=null,milestoneColor="yellow",milestoneStart=0,reached=new Set();

    // üì¶ Recursos (sin fondo del men√∫ ni audio para no bloquear)
    const playerImg=new Image();playerImg.decoding="async";playerImg.src="gato.png";
    const cloudImgs=["nube_grande.png","nube_peque√±a.png","nube_negra.png","nube_negra_peque√±a.png"].map(s=>{let i=new Image();i.decoding="async";i.src=s;return i;});
    const demonImg=new Image();demonImg.decoding="async";demonImg.src="demonio.png"; // garantiza carga de pantalla game over
    const milestones=[
      {at:20,label:"DEVOTED",color:"gray"},
      {at:40,label:"ENLIGHTENED",color:"orange"},
      {at:60,label:"BLESSED",color:"yellow"},
      {at:80,label:"MONK",color:"#FFD700"}
    ];

    function resetPlayer(){rotation=0;return{x:GAME_WIDTH/2-28,y:GAME_HEIGHT-120,w:56,h:56,speed:basePlayerSpeed};}
    function newCloud(){const img=cloudImgs[Math.floor(Math.random()*cloudImgs.length)],size=70+Math.random()*50;return{x:Math.random()*(GAME_WIDTH-size),y:-size,w:size,h:size,speed:1+speedFactor,img};}
    function buildStars(){stars=[];for(let i=0;i<120;i++)stars.push({x:Math.random()*GAME_WIDTH,y:Math.random()*GAME_HEIGHT,r:Math.random()*2,color:Math.random()>0.5?"yellow":"black",speed:0.2+Math.random()*0.8});}

    function maybeMilestone(){
      for(const m of milestones){
        if(score>=m.at&&!reached.has(m.at)){
          reached.add(m.at);milestoneMsg=m.label;milestoneColor=m.color;milestoneStart=performance.now();
          if(m.label==="DEVOTED"){speedFactor+=1.0;spawnEvery=1000;}
          else if(m.label==="ENLIGHTENED"){speedFactor+=1.2;spawnEvery=700;}
          else if(m.label==="BLESSED"){speedFactor+=1.5;spawnEvery=500;}
          else if(m.label==="MONK"){speedFactor+=2.0;spawnEvery=300;}
          player.speed=basePlayerSpeed*(1+(speedFactor-1)/2);
        }
      }
    }

    function drawMilestone(now){
      if(!milestoneMsg)return;
      const elapsed=now-milestoneStart;
      if(elapsed>1500){milestoneMsg=null;return;}
      ctx.save();ctx.fillStyle=milestoneColor;ctx.font="40px system-ui, sans-serif";
      ctx.textAlign="center";ctx.fillText(milestoneMsg,GAME_WIDTH/2,GAME_HEIGHT/2);ctx.restore();
    }

    function endGame(){
      running=false;
      bgMusic.pause();
      gameOverScreen.style.display="flex";
      finalScoreDisplay.textContent="Score: "+Math.floor(score);
      let best=Number(localStorage.getItem("bestScore")||0);
      if(score>best){localStorage.setItem("bestScore",Math.floor(score));best=score;}
      bestScoreDisplay.textContent=best;
    }

    function startGame(){
      player=resetPlayer();clouds=[];buildStars();score=0;spawnTimer=0;speedFactor=1.5;
      spawnEvery=1500;falling=false;rotation=0;milestoneMsg=null;reached.clear();
      menu.style.display="none";gameOverScreen.style.display="none";running=true;
      try{bgMusic.currentTime=0;bgMusic.play().catch(()=>{});}catch(e){}
      requestAnimationFrame(loop);
    }

    const keys={};
    window.addEventListener("keydown",e=>{if(e.code==="Space"){if(menu.style.display!=="none"||gameOverScreen.style.display!=="none")startGame();e.preventDefault();return;}keys[e.key.toLowerCase()]=true;});
    window.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false;});
    playBtn.addEventListener("click",startGame);againBtn.addEventListener("click",startGame);

    function triggerFall(){falling=true;fallVelocity=-8;rotation=0;}

    // üéÆ JOYSTICK DIGITAL
    let joyActive=false,joyCenter={x:0,y:0},joyPos={x:0,y:0};
    const joyMax=50;
    canvas.addEventListener("touchstart",e=>{
      if(!running)return;
      const t=e.touches[0];
      joyActive=true;
      joyCenter.x=t.clientX;joyCenter.y=t.clientY;
      joystick.style.display="block";
      joystick.style.left=(joyCenter.x-60)+"px";
      joystick.style.top=(joyCenter.y-60)+"px";
    });
    canvas.addEventListener("touchmove",e=>{
      if(!joyActive)return;
      const t=e.touches[0];
      let dx=t.clientX-joyCenter.x,dy=t.clientY-joyCenter.y;
      const dist=Math.min(Math.sqrt(dx*dx+dy*dy),joyMax);
      const angle=Math.atan2(dy,dx);
      joyPos.x=Math.cos(angle)*dist/joyMax;joyPos.y=Math.sin(angle)*dist/joyMax;
      joystickKnob.style.transform=`translate(${joyPos.x*40}px,${joyPos.y*40}px)`;
    });
    canvas.addEventListener("touchend",()=>{
      joyActive=false;joyPos.x=0;joyPos.y=0;
      joystick.style.display="none";joystickKnob.style.transform="translate(0,0)";
    });

    function loop(now){
      if(!running)return;
      const dt=Math.min(50,now-lastFrame);lastFrame=now;
      ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT);

      for(const s of stars){s.y+=s.speed;if(s.y>GAME_HEIGHT){s.y=0;s.x=Math.random()*GAME_WIDTH;}ctx.fillStyle=s.color;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}

      if(!falling){
        if(keys["a"]||keys["arrowleft"])player.x-=player.speed;
        if(keys["d"]||keys["arrowright"])player.x+=player.speed;
        if(keys["w"]||keys["arrowup"])player.y-=player.speed;
        if(keys["s"]||keys["arrowdown"])player.y+=player.speed;

        player.x+=joyPos.x*player.speed*3;
        player.y+=joyPos.y*player.speed*3;

        player.x=Math.max(0,Math.min(GAME_WIDTH-player.w,player.x));
        player.y=Math.max(0,Math.min(GAME_HEIGHT-player.h,player.y));
      } else {
        fallVelocity+=0.5;player.y+=fallVelocity;rotation+=0.12;
        if(player.y>GAME_HEIGHT+40){endGame();return;}
      }

      spawnTimer+=dt;while(spawnTimer>=spawnEvery){spawnTimer-=spawnEvery;clouds.push(newCloud());}
      const pRect={x:player.x,y:player.y,w:player.w,h:player.h};
      for(let i=0;i<clouds.length;i++){
        const c=clouds[i];c.y+=c.speed;ctx.drawImage(c.img,c.x,c.y,c.w,c.h);
        if(!falling && !(pRect.x+pRect.w<c.x||pRect.x>c.x+c.w||pRect.y+pRect.h<c.y||pRect.y>c.y+c.h)){triggerFall();}
        if(c.y>GAME_HEIGHT+60){clouds.splice(i,1);i--;}
      }

      ctx.save();ctx.translate(player.x+player.w/2,player.y+player.h/2);ctx.rotate(rotation);
      ctx.drawImage(playerImg,-player.w/2,-player.h/2,player.w,player.h);ctx.restore();

      if(!falling){score+=dt/1000;maybeMilestone();}
      ctx.fillStyle="yellow";ctx.font="20px system-ui, sans-serif";ctx.fillText("Score: "+Math.floor(score),10,30);
      drawMilestone(now);

      requestAnimationFrame(loop);
    }

    // üöÄ PRECARGA con progreso (solo im√°genes del juego, no audio ni fondo del men√∫)
    const resources=[playerImg,...cloudImgs,demonImg];
    let loaded=0;
    function updateProgress(){
      loaded++;
      const pct=Math.round((loaded/resources.length)*100);
      progressBar.style.width=pct+"%";
      loadingPercent.textContent=pct+"%";
      if(loaded>=resources.length){showMenu();}
    }
    // Cuenta tanto LOAD como ERROR para no quedarse colgado si falla alguien
    resources.forEach(r=>{
      r.addEventListener("load",updateProgress,{once:true});
      r.addEventListener("error",updateProgress,{once:true});
    });

    function showMenu(){
      // Inyecta el fondo del men√∫ reci√©n ahora (para no bloquear primer render)
      const bgSrc=menu.dataset.bgSrc;
      if(bgSrc){ menu.style.backgroundImage=`url("${bgSrc}")`; }
      loadingScreen.style.display="none";
      menu.style.display="flex";
      // Mostrar r√©cord
      bestScoreDisplay.textContent=Number(localStorage.getItem("bestScore")||0);
    }

    // Fallback duro: si algo tarda demasiado, no bloquees al usuario
    setTimeout(()=>{
      if(loadingScreen.style.display!=="none"){
        showMenu();
      }
    },7000);
  })();
  </script>
</body>
</html>
